(function(){"use strict";var g=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",[n("k-grid",{staticStyle:{gap:"0.25rem","--columns":"12"}},[n("k-input",t._b({staticStyle:{"--width":"1/3"},attrs:{type:"text"},on:{input:t.onInput},model:{value:t.content.name,callback:function(i){t.$set(t.content,"name",i)},expression:"content.name"}},"k-input",t.field("name"),!1)),t.loading?n("k-box",{staticStyle:{"--width":"2/3"},attrs:{theme:"info",icon:"loader",text:t.$t("form.block.inbox.loading")}}):n("k-box",{staticStyle:{"--width":"2/3"},attrs:{icon:"email",theme:t.status.theme,text:t.$t("form.block.inbox.show")+" ("+t.status.text+")"},nativeOn:{click:function(i){return t.open.apply(null,arguments)}}})],1)],1)},$=[];function d(t,e,n,i,a,r,_,G){var s=typeof t=="function"?t.options:t;e&&(s.render=e,s.staticRenderFns=n,s._compiled=!0),i&&(s.functional=!0),r&&(s._scopeId="data-v-"+r);var l;if(_?(l=function(o){o=o||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext,!o&&typeof __VUE_SSR_CONTEXT__!="undefined"&&(o=__VUE_SSR_CONTEXT__),a&&a.call(this,o),o&&o._registeredComponents&&o._registeredComponents.add(_)},s._ssrRegister=l):a&&(l=G?function(){a.call(this,(s.functional?this.parent:this).$root.$options.shadowRoot)}:a),l)if(s.functional){s._injectStyles=l;var K=s.render;s.render=function(P,v){return l.call(v),K(P,v)}}else{var p=s.beforeCreate;s.beforeCreate=p?[].concat(p,l):[l]}return{exports:t,options:s}}const b={data(){return{migrate:!1,loading:!0,status:{type:Object,default:{count:"-",read:"-",fail:"-",state:"wait"}}}},destroyed(){window.panel.events.off("form.update",this.updateCount)},created(){this.$store.subscribe(function(t){t.type=="content/STATUS"&&window.panel.events.emit("form.update")}),this.content.formid=this.id,this.updateCount(),window.panel.events.on("form.update",this.updateCount)},methods:{updateCount(){const t=this;this.$api.get("formblock",{action:"info",form_id:this.id,params:JSON.stringify({form_name:this.content.name})}).then(e=>{t.status=e,this.loading=!1})},onInput(t){this.$emit("update",t)}}},u={};var k=d(b,g,$,!1,y,null,null,null);function y(t){for(let e in u)this[e]=u[e]}var x=function(){return k.exports}(),w=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("k-dialog",t._b({ref:"dialog",staticClass:"k-field-type-page-dialog",on:{cancel:function(i){return t.$emit("cancel")},submit:function(i){return t.$emit("submit")}}},"k-dialog",t.$props,!1),[n("k-headline",[t._v(t._s(t.current.title))]),t.current.formfields?n("div",[n("table",{staticClass:"k-field-type-page-dialog-table"},t._l(t.current.formfields,function(i,a){return n("tr",{key:a,class:"field_"+a},[n("td",[t._v(t._s(i))]),t.current.attachment[a]?n("td",[n("ul",{staticClass:"k-field-type-page-dialog-linklist"},t._l(t.current.attachment[a],function(r){return n("li",{key:r.tmp_name},[n("a",{staticClass:"k-field-type-page-dialog-link",attrs:{href:r.location,download:r.name}},[n("k-icon",{attrs:{type:"attachment"}}),t._v(" "+t._s(r.name)+" ")],1)])}),0)]):n("td",[t._v(" "+t._s(t.current.formdata[a])+" ")])])}),0)]):n("div",{staticClass:"k-field-type-page-dialog-table"},[t._v(" "+t._s(t.current.formdata.summary)+" ")]),t.current.error?n("k-box",{attrs:{text:t.current.error,theme:"negative"}}):t._e()],1)},O=[],Q="";const S={extends:"k-dialog",props:{current:{type:Object,default(){}}}},c={};var C=d(S,w,O,!1,M,null,null,null);function M(t){for(let e in c)this[e]=c[e]}var R=function(){return C.exports}(),j=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"k-mailview-list"},[t.hideheader?t._e():n("k-box",{attrs:{theme:t.value.header.state.theme,icon:t.isOpen?"angle-up":"angle-down",text:t.headerText},nativeOn:{click:function(i){return t.toggleOpen()}}}),t.isOpen||t.hideheader?n("k-items",{attrs:{items:t.items}}):t._e()],1)},Y=[];const B={props:{value:{type:Array,required:!0},showuuid:Boolean,hideheader:Boolean},data(){return{isOpen:!1}},computed:{items(){return this.value.content.length===0?[{text:this.$t("form.block.inbox.empty"),theme:"disabled"}]:this.value.content},headerText(){return this.showuuid?this.value.header.name+" ("+this.value.uuid+")":this.value.header.name}},created(){this.isOpen=sessionStorage.getItem(`microman.form.showOpen.${this.value.page}.${this.value.uuid}`)==="on"},methods:{toggleOpen(){this.isOpen=!this.isOpen,sessionStorage.setItem(`microman.form.showOpen.${this.value.page}.${this.value.uuid}`,this.isOpen?"on":"off")}}},f={};var D=d(B,j,Y,!1,F,null,null,null);function F(t){for(let e in f)this[e]=f[e]}var L=function(){return D.exports}(),T=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"k-field-type-mail-view"},[t.loading?n("k-box",{attrs:{theme:"info",icon:"loader",text:t.$t("form.block.inbox.loading")}}):n("k-grid",{attrs:{variant:"fields"}},[t.license.length>0?n("k-formblock-license",{staticStyle:{"--width":"1/1"},attrs:{text:t.license}}):t._e(),t._l(t.data,function(i){return n("k-mail-list",{key:i.slug,staticClass:"k-table k-field-type-mail-table",staticStyle:{"--width":"1/1"},attrs:{hideheader:t.hideheader,value:i,showuuid:t.isUnique(i)},on:{setRead:t.setRead,deleteMail:t.deleteMail}})}),t.data.length===0?n("k-box",{staticStyle:{"--width":"1/1"},attrs:{theme:"info",text:t.$t("form.block.inbox.empty")}}):t._e()],2)],1)},N=[];const E={props:{value:{type:String,default:""},dateformat:{type:String,default:"DD.MM.YYYY HH:mm"},forms:{type:Array,default:()=>[]},formData:{type:Object,default:()=>{}},license:{type:String,default(){return""}}},data(){return{data:[],filter:[],loading:!0,hideheader:!1}},computed:{thispage(){return this.$attrs.endpoints.model.replace("/pages/","").replace(/\+/g,"/")}},created(){this.formData.formid?(this.filter=[this.formData.formid],this.hideheader=!0):this.filter=this.forms,this.updateList(),window.panel.events.on("form.update",this.updateList)},destroyed(){window.panel.events.off("form.update",this.updateList)},methods:{send(t,e,n){var i,a;this.$api.get("formblock",{action:t,page_id:this.thispage,request_id:(i=e==null?void 0:e.request)!=null?i:"",form_id:(a=e==null?void 0:e.form)!=null?a:"",params:JSON.stringify(e)}).then(r=>{this.loading=!1,n(r)})},isUnique(t){return this.data.filter(e=>t.header.page===e.header.page&&t.header.name===e.header.name).length>1},updateList(){let t=this;this.send("requestsArray",{filter:this.filter},e=>{this.data=Object.keys(e).map(function(n){return e[n].content=e[n].content.map(i=>{i.formid=n,i.attachment="attachment"in i?JSON.parse(i.attachment):!1,i.formdata=JSON.parse(i.formdata),i.formfields="formfields"in i?JSON.parse(i.formfields):!1;let a=t.$library.dayjs(i.received,"YYYY-MM-DD HH:mm:ss");return i.info=a.isValid()?a.format(t.dateformat):"",i.text=t.getLabel(i),i.image=t.getImage(i),i.buttons=[t.getButton("info",i)],i.options=[i.read===""?t.getButton("unread",i):t.getButton("read",i),t.getButton("delete",i)],i}),e[n]})})},setRead(t,e){this.send("update",{form:e.formid,request:e.slug,read:t==!1?"":this.$library.dayjs().format("YYYY-MM-DD HH:mm:ss")},()=>{window.panel.events.emit("form.update"),this.$panel.dialog.close()})},getLabel(t){return t.display?t.display:this.value?this.$helper.string.template(this.value,t.formdata):t.id},getButton(t,e){return t==="delete"?{icon:"trash",text:this.$t("form.block.inbox.delete"),click:()=>this.send("delete",{form:e.formid,request:e.slug},()=>{window.panel.events.emit("form.update")})}:t==="unread"?{icon:"preview",text:this.$t("form.block.inbox.asread"),click:()=>this.setRead(!0,e)}:t==="read"?{icon:"hidden",text:this.$t("form.block.inbox.asunread"),click:()=>this.setRead(!1,e)}:{icon:"info",click:()=>this.$panel.dialog.open({component:"k-mail-dialog",props:{current:e,size:"medium",submitButton:e.read?{}:this.getButton("unread",e),cancelButton:e.read?this.getButton("read",e):{}}})}},getImage(t){const e={back:"transparent"};return t.read?Object.assign(e,{icon:"circle",color:"info"}):t.error?Object.assign(e,{icon:"cancel",color:"negative"}):Object.assign(e,{icon:"circle-filled",color:"positive"})}}},h={};var H=d(E,T,N,!1,I,null,null,null);function I(t){for(let e in h)this[e]=h[e]}var J=function(){return H.exports}(),U=function(){var t=this,e=t.$createElement,n=t._self._c||e;return t.msg.length>0?n("k-box",{staticClass:"k-formblock-license",attrs:{theme:t.state}},[t._v(" "+t._s(t.$t(t.msg))+" "),t.state==="notice"?n("span",{attrs:{href:"#"},on:{click:function(i){return t.dialog()}}},[t._v(t._s(t.$t("form.block.license.info.link")))]):t._e()]):t._e()},A=[],Z="";const V={props:{text:{type:String,default(){return""}}},data(){return{state:"notice",msg:this.text}},methods:{dialog(){const t=this;this.$dialog("formblock/register",{on:{success(e){t.msg=e.message,t.state="positive",t.$panel.dialog.close()}}})}}},m={};var z=d(V,U,A,!1,X,null,null,null);function X(t){for(let e in m)this[e]=m[e]}var W=function(){return z.exports}();window.panel.plugin("microman/formblock",{fields:{mailview:J},components:{"k-mail-list":L,"k-mail-dialog":R,"k-formblock-license":W},blocks:{form:x}})})();
